---
title: "GAM Hirsutism"
output:
  html_document: default
  pdf_document: default
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
# Clear environment
rm(list=ls())

# Load necessary packages
if(!require("mgcv")) {
  install.packages("mgcv", dependencies=TRUE)
  library(mgcv)
}
```

```{r}
# 1. Data Import and Preparation

# Bear in mind that there may be some observations with missing values (NA)
hirs <- read.table("hirsutism.dat",header=T, sep="\t",fill=TRUE)

# Check structure and ensure that Treatment is a factor

summary(hirs)

hirs$Treatment <- as.factor(hirs$Treatment)
```

We have 8 observation, out of 99, that have missing record in patient baseline, but we do have the corresponding treatment result register.

We use the library 'mice' to impute missing values.

```{r}
library(mice)
imputed_data <- mice(hirs, m = 5, method = 'pmm', seed = 123)
hirs <- complete(imputed_data)
summary(is.na(hirs))
```


```{r}
# 2. Exploratory Data Analysis

summary(hirs)
attach(hirs)

boxplot(hirs[,2:5])

par(mfrow=c(2,2))
boxplot(hirs[,2]~Treatment,ylim=c(0,30), main=names(hirs)[2], xlab="Treatment")
boxplot(hirs[,3]~Treatment,ylim=c(0,30), main=names(hirs)[3], xlab="Treatment")
boxplot(hirs[,4]~Treatment,ylim=c(0,30), main=names(hirs)[4], xlab="Treatment")
boxplot(hirs[,5]~Treatment,ylim=c(0,30), main=names(hirs)[5], xlab="Treatment")
par(mfrow=c(1,1))

par(mfrow=c(2,2))
boxplot(hirs[Treatment==0,2:5],ylim=c(0,30), main="Treatment 0")
boxplot(hirs[Treatment==1,2:5],ylim=c(0,30), main="Treatment 1")
boxplot(hirs[Treatment==2,2:5],ylim=c(0,30), main="Treatment 2")
boxplot(hirs[Treatment==3,2:5],ylim=c(0,30), main="Treatment 3")
par(mfrow=c(1,1))

```

We can conclude in these four clusters that, even with contraceptive only (Treatment 0), there is a improvement of hirsutism after 12 month of treatment, although not that significant compared with other with antiandrogen.

```{r}
# 3. Fit Candidate GAM Models with increasing complexity.

# Model 1: A very simple model including only FGm0 and Treatment
m1 <- gam(FGm12 ~ Treatment + s(FGm0),
          data = hirs, method = "REML")

# Model 2: A more complex model model revealing the relation with patient physical status
m2 <- gam(FGm12 ~ Treatment + s(FGm0) + s(weight) + s(height),
          data = hirs, method = "REML")
# In this case, we will apply smooth function, s(), among the variables, to capture
# possible no-linear correlation between numerical feature and our target variable.

# Model 3: Include all baseline continuous vars as smooth terms and Treatment as a factor
m3 <- gam(FGm12 ~ Treatment + s(FGm0) + s(SysPres) + s(DiaPres) + 
          s(weight) + s(height),data = hirs, method = "REML")

# Model 4: Allow the relationship with FGm0 to differ by Treatment (using a by-factor smooth) 
m4 <- gam(FGm12 ~ Treatment + s(FGm0, by=Treatment) + 
          s(SysPres) + s(DiaPres) + s(weight) + s(height),
          data = hirs, method = "REML")

# Stack all the models into a list for easy comparison.
models <- list(m1=m1, m2=m2, m3=m3, m4=m4)
```

Then let's do a simple model comparison.

```{r}
# 4. Model comparison (R-sq and Deviance explained metrics)

for (m_name in names(models)) {
  m <- models[[m_name]]
  
  cat("----------", m_name, "----------\n")
  
  # Model summary
  s <- summary(m)
  print(s)
  
  # Model plots
  par(mfrow=c(2,2))
  plot(m, all.terms=TRUE, shade=TRUE, main=paste("Plots:", m_name))
  par(mfrow=c(1,1))
  
  # Example vis.gam (only if model has at least two continuous predictors)
  if("weight" %in% names(m$model) && "FGm0" %in% names(m$model)){
    vis.gam(m, view=c("FGm0","weight"), cond=list(Treatment=levels(hirs$Treatment)[1]),
            theta=45, color="topo", main=paste("vis.gam:", m_name, "(FGm0 vs weight)"))
  }

  # gam.check
  cat("gam.check for", m_name, "\n")
  gam.check(m)
}
```


The first model has a low R-squared (0.252) and the deviance explained is also very low (30%).The next models improve the performance and the best one seems to be the fourth one, with a R-squared value of 0.308 and explained deviance of 42.7%.

```{r}
# Taking fourth model as baseline, let's try with different method instead of "REML"

m5 <- gam(FGm12 ~ Treatment + s(FGm0, by=Treatment) + 
          s(SysPres) + s(DiaPres) + s(weight) + s(height),
          data = hirs, method = "GCV.Cp")

m6 <- gam(FGm12 ~ Treatment + s(FGm0, by=Treatment) + 
          s(SysPres) + s(DiaPres) + s(weight) + s(height),
          data = hirs, method = "ML")
```


```{r}
# 5. Model Comparison with Anova
# Use ANOVA to compare nested models. Note: 
# - Strictly, m4 is not nested in m3 (different structure due to by=Treatment),
#   but we can still get some insight. For nested comparisons, focus on models
#   that differ by terms. Alternatively, compare AIC for all models.

anova(m4, m5, m6, test="F")

AIC(m4, m5, m6)

```

Comparing the Anova we can observe that the model 5 is the one with the lowest residual deviance. We can observe that the change between the fourth model and the fifth model is significant, so we can confirm that the change in the method was useful.

Regarding the AIC, the lowest one is m5 too so it re-affirms the previous observation.

```{r}
summary(m5)

# Examine partial effects more thoroughly:
par(mfrow=c(2,3))
plot(m5, all.terms=TRUE, shade=TRUE, main="Final Model (m5)")
par(mfrow=c(1,1))

# Visualize 3D surfaces for interesting pairs of predictors:
vis.gam(m5, view=c("FGm0","weight"), cond=list(Treatment="2"), 
        theta=30, color="terrain", main="M5:")
```


The adjusted R-squared indicates that 0.375 of the variability in FGm12 is explained by the model. We think we may need to include more variables to improve the model.

Analysing the variables, we can see that Systolic blood pressure (s(SysPres)) shows a significant linear effect on FGm12. Diastolic blood pressure (s(DiaPres)), weight (s(weight)), and height (s(height)) were not significant predictors.

All treatment groups (1, 2, and 3) showed significant reductions in FGm12 compared to the reference group (Treatment0), with the greatest reduction in Treatment1.
